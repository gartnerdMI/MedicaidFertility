* NOTES: The code used to create analytic datasets used in the following analyses, is not 
* included below. Rather, descriptions of the datasets and variable names are provided.
* Original dataset names and versions used to create analytic datasets are included in 
* the manuscript.

* This code is organized into the following steps:
* STEP 1: Install package and update
* STEP 2: Parallel trends assessment
* STEP 3: Difference in differences analyses
* STEP 4: Sensitivity analysis, exclude births within 1 year of expansion
* STEP 5: Sensitivity analysis, recode 5 states/DC as "control" states
* STEP 6: Sensitivity analysis, recode missing marital status, parity and education



***STEP 1: Install reghdfe and ms_get_version
sysdir
*Original PLUS was:  c:\ado\plus\
sysdir set PLUS "ENTER LOCATION"
sysdir
ssc install reghdfe, replace
ssc install outreg2, replace


***STEP 2: Conduct Parallel Trends Assessment

***STEP 2a: Set up log
log using fert_parallel_Year, replace

***STEP 2b: Read in data for overall/aggregated parallel trends assumption,
***create new variables, and run regression

* Dataset (RatesY_Expansion.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state counts of live births (births) from natality data, 
* year by state population size (popsize) from SEER data, expansion status (expansion), 
* state by year unemployment rates (Unempl), and year relative to expansion (relYpos) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Expansion.dta", clear

*create numerical value for state id, year, and log of births and pop size
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(popsize)
egen year = group(birthyear)

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum) 
*save to excel
outreg2 using option4Year_regression.xls, stats(coef ci) replace excel dec(3)
*F test
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion


***STEP 2c: Read in data for age-stratified (3 grps) parallel trends assumption,
***create new variables, and run regression

* Dataset (RatesY_AgeGroups.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and age counts of live births(births) from natality data, 
* year by state and age population size (popsize) from SEER data, expansion status 
* (expansion), state by year unemployment rates (Unempl), age group (newagegrp_f),
* and year relative to expansion (relYpos)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_AgeGroups.dta", clear

*create numerical value for state id, year, and log of births and pop size
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(popsize)
egen year = group(birthyear)

**AGES 18-24**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f == 1
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion

**AGES 25-34**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f == 2
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion

**AGES 35-44**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f == 3
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion


***STEP 2d: Read in data for marital status-stratified (2 grps) parallel trends assumption,
***create new variables, and run regression

* Dataset (RatesY_Marriage.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and marital status counts of live births (marbirths) from natality data, 
* year by state and marital status population size (mardenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl), 
* marital status (marital), and year relative to expansion (relYpos)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Marriage.dta", clear

*create numerical value for state id, year, and log of birth and pop
egen statenum = group(mrstate)
gen lnbirth = ln(marbirths)
gen lnpop = ln(mardenY)
egen year = group(birthyear)

**MARRIED**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marital == 1
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion

**NOT MARRIED**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marital == 2
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion


***STEP 2e: Read in data for parity-stratified (2 grps) parallel trends assumption,
***create new variables, and run regression

* Dataset (RatesY_Parity.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and parity counts of live births (births) from natality data, 
* year by state and parity population size (pardenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl), 
* parity (prev_children), and year relative to expansion (relYpos)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Parity.dta", clear

*create numerical value for state id, year and log of births and popsize
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(pardenY)
egen year = group(birthyear)

**No Children At Home**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prev_children == 0 
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion

**Children At Home**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prev_children == 1 
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion


***STEP 2f: Read in data for education-stratified (4 grps) parallel trends assumption,
***create new variables, and run regression

* Dataset (RatesY_Education.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and education level counts of live births (edubirths) from natality data, 
* year by state and education level population size (edudenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl), 
* education level (newedu), and year relative to expansion (relYpos)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Education.dta", clear

*create numerical value for state id, year and log of births
egen statenum = group(mrstate)
gen lnbirth = ln(edubirths)
gen lnpop = ln(edudenY)
egen year = group(birthyear)

**Less than HS**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu == 1 
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion

**HS**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu == 2 
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion

**Some College**

*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu == 3 
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion

**College +**
*OLS w/ log of birth counts as outcome
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions
*set reference to be the year prior to expansion (relY = 0; relYpos = 6)
reghdfe lnbirth ib6.relYpos##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu == 4 
outreg2 using option4Year_regression.xls, stats(coef ci) append excel dec(3)
testparm 3.relYpos#1.expansion 4.relYpos#1.expansion 5.relYpos#1.expansion

***STEP 2g: export log to pdf format 
translate fert_parallel_Year.smcl fert_parallel_Year.pdf, replace



***STEP 3: DID Analyses
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions


***STEP 3a: Set up log
log using fert_didY, replace


***STEP 3b: Read in data for overall/aggregated births DID, create new variables, and run regression

* Dataset (RatesY_Expansion.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state counts of live births (births) from natality data, year by state 
* population size (popsize) from SEER data, expansion status (expansion), 
* state by year unemployment rates (Unempl), and post expansion indicator (post)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Expansion.dta", clear

*create numerical value for state id, year, and log of births and pop size
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(popsize)
egen year = group(birthyear)

*run regression
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum) 
*Save output to excel
outreg2 using DiD_regressionY.xls, stats(coef ci) replace excel dec(3)


***STEP 3c: Read in data for age-stratified (3 grps) DID, create new variables, and run regression

* Dataset (RatesY_AgeGroups.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and age counts of live births (births) from natality data, 
* year by state and age population size (popsize) from SEER data, expansion status 
* (expansion), state by year unemployment rates (Unempl), age group (newagegrp_f), 
* and post expansion indicator (post)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_AgeGroups.dta", clear

*create numerical value for state id, year, and log of births and pop size
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(popsize)
egen year = group(birthyear)

**AGES 18-24**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f==1 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)

**AGES 25-34**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f==2 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)

**AGES 35-44**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f==3 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)


***STEP 3d: Read in data for marital status-stratified (2 grps) DID,
***create new variables, and run regression

* Dataset (RatesY_Marriage.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and marital status counts of live births (marbirths) from natality data, 
* year by state and marital status population size (mardenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl), 
* marital status (marital), and post expansion indicator (post)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Marriage.dta", clear

*create numerical value for state id, year, and log of birth and pop
egen statenum = group(mrstate)
gen lnbirth = ln(marbirths)
gen lnpop = ln(mardenY)
egen year = group(birthyear)

**MARRIED**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marital==1 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)

**UNMARRIED**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marital==2 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)


***STEP 3e: Read in data for parity-stratified (2 grps) DID,
***create new variables, and run regression

* Dataset (RatesY_Parity.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and parity counts of live births (births) from natality data, 
* year by state and parity population size (pardenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl), and 
* parity (prev_children), and post expansion indicator (post)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Parity.dta", clear

*create numerical value for state id, year and log of births
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(pardenY)
egen year = group(birthyear)

**No Children At Home**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prev_children==0 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)

**Children At Home**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prev_children==1 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)


***STEP 3f: Read in data for education-stratified (4 grps) DID,
***create new variables, and run regression

* Dataset (RatesY_Education.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and education level counts of live births (edubirths) from natality data, 
* year by state and education level population size (edudenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl), 
* education level (newedu), and post expansion indicator (post)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Education.dta", clear

*create numerical value for state id, year and log of births
egen statenum = group(mrstate)
gen lnbirth = ln(edubirths)
gen lnpop = ln(edudenY)
egen year = group(birthyear)

**Less than HS**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==1 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)

**HS**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==2 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)

**Some College**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==3 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)

**College+**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==4 
outreg2 using DiD_regressionY.xls, stats(coef ci) append excel dec(3)


***STEP 3g: export log to pdf format 
translate fert_didY.smcl fert_didY.pdf, replace



***STEP 4: Sensitivity Analysis, exclude births within one year of expansion
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions


***STEP 4a: Set up log
log using fert_sensexclude, replace


***STEP 4b: Read in data for overall/aggregated births DID sens, create new variables, and run regression

* Dataset (RatesY_Expansion.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state counts of live births (births) from natality data, year by state 
* population size (popsize) from SEER data, expansion status (expansion), 
* state by year unemployment rates (Unempl), relative year
* (relY), and post expansion date indicator (post) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Expansion.dta", clear

*create numerical value for state id, year, and log of births and pop size
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(popsize)
egen year = group(birthyear)

*run regression
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if relY !=0
*Save output to excel
outreg2 using DiD_sensexclude.xls, stats(coef ci) replace excel dec(3)


***STEP 4c: Read in data for age-stratified (3 grps) DID sens, create new variables, and run regression

* Dataset (RatesY_AgeGroups.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and age counts of live births (births) from natality data, year by 
* state and age population size (popsize) from SEER data, expansion status (expansion), 
* state by year unemployment rates (Unempl), age group (newagegrp_f), relative year
* (relY) and post expansion date indicator (post) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_AgeGroups.dta", clear

*create numerical value for state id, year, and log of births and pop size
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(popsize)
egen year = group(birthyear)

**AGES 18-24**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f==1 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)

**AGES 25-34**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f==2 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)

**AGES 35-44**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newagegrp_f==3 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)


***STEP 4d: Read in data for marital status-stratified (2 grps) DID,
***create new variables, and run regression

* Dataset (RatesY_Marriage.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and marital status counts of live births (marbirths) from natality data, 
* year by state and marital status population size (mardenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl), 
* marital status (marital), relative year (relY) and post expansion date indicator (post) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Marriage.dta", clear

*create numerical value for state id, year, and log of birth and pop
egen statenum = group(mrstate)
gen lnbirth = ln(marbirths)
gen lnpop = ln(mardenY)
egen year = group(birthyear)

**MARRIED**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marital==1 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)

**UNMARRIED**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marital==2 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)


***STEP 4e: Read in data for parity-stratified (2 grps) DID,
***create new variables, and run regression

* Dataset (RatesY_Parity.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and parity counts of live births (births) from natality data, 
* year by state and parity population size (pardenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl),  
* parity (prev_children), relative year (relY) and post expansion date indicator (post) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Parity.dta", clear

*create numerical value for state id, year and log of births
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(pardenY)
egen year = group(birthyear)

**No Children At Home**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prev_children==0 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)

**Children At Home**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prev_children==1 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)


***STEP 4f: Read in data for education-stratified (4 grps) DID,
***create new variables, and run regression

* Dataset (RatesY_Education.dta) created using R and includes state(mrstate), year(birthyear), 
* year by state and education level counts of live births (edubirths) from natality data, 
* year by state and education level population size (edudenY) from SEER and Census data, 
* expansion status (expansion), state by year unemployment rates (Unempl), 
* education level (newedu), relative year (relY) and post expansion date indicator (post) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Education.dta", clear

*create numerical value for state id, year and log of births
egen statenum = group(mrstate)
gen lnbirth = ln(edubirths)
gen lnpop = ln(edudenY)
egen year = group(birthyear)

**Less than HS**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==1 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)

**HS**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==2 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)

**Some College**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==3 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)

**College+**
reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==4 & relY !=0
outreg2 using DiD_sensexclude.xls, stats(coef ci) append excel dec(3)


***STEP 4g: export log to pdf format 
translate fert_sensexclude.smcl fert_sensexclude.pdf, replace



***STEP 5: Sensitivity Analysis, recategorize 5 states
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions


***STEP 5a: Set up log
log using fert_sens5recode, replace


***STEP 5b: Read in data for overall/aggregated births DID sens, create new variables, and run regression

* Dataset (RatesY_Expansion5Recode.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state counts of live births (births) from natality data, 
* year by state population size (popsize) from SEER data, state by year unemployment 
* rates (Unempl), recoded expansion indicator (sensexp), post expansion date 
* indicator (post) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Expansion5Recode.dta", clear

*create numerical value for state id, year, and log of births and pop size
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(popsize)
egen year = group(birthyear)

*run regression
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum) 
*save output to excel
outreg2 using DiD_sens5recode.xls, stats(coef ci) replace excel dec(3)


***STEP 5c: Read in data for age-stratified (3 grps) DID sens, create new variables, and run regression

* Dataset (RatesY_AgeGroups5Recode.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and age counts of live births (births) from natality data, 
* year by state and age population size (popsize) from SEER data, state by year unemployment 
* rates (Unempl), recoded expansion indicator (sensexp), post expansion date 
* indicator (post), and age group (newagegrp_f)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_AgeGroups5Recode.dta", clear

*create numerical value for state id, year, and log of births and pop size
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(popsize)
egen year = group(birthyear)
gen agegrp = 1 if newagegrp_f=="18-24 yrs"
replace agegrp = 2 if newagegrp_f=="25-34 yrs"
replace agegrp = 3 if newagegrp_f=="35-44 yrs"

**AGES 18-24**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if agegrp==1 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)

**AGES 25-34**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if agegrp==2 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)

**AGES 35-44**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if agegrp==3 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)


***STEP 5d: Read in data for marital status-stratified (2 grps) DID sens,
***create new variables, and run regression

* Dataset (RatesY_Marriage5Recode.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and marital status counts of live births (marbirths) 
* from natality data, year by state and marital status population size (mardenY) 
* from SEER data, state by year unemployment rates (Unempl), recoded expansion 
* indicator (sensexp), post expansion date indicator (post), and marital status 
* (marital)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Marriage5Recode.dta", clear

*create numerical value for state id, year, and log of birth and pop
egen statenum = group(mrstate)
gen lnbirth = ln(marbirths)
gen lnpop = ln(mardenY)
egen year = group(birthyear)

**MARRIED**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marital==1 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)

**UNMARRIED**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marital==2 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)


***STEP 5e: Read in data for parity-stratified (2 grps) DID sens,
***create new variables, and run regression

* Dataset (RatesY_Parity5Recode.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and parity counts of live births (births) 
* from natality data, year by state and parity population size (pardenY) 
* from SEER data, state by year unemployment rates (Unempl), recoded expansion 
* indicator (sensexp), post expansion date indicator (post), and parity (prev_children) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Parity5Recode.dta", clear

*create numerical value for state id, year and log of births
egen statenum = group(mrstate)
gen lnbirth = ln(births)
gen lnpop = ln(pardenY)
egen year = group(birthyear)

**No Children At Home**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prev_children==0 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)

**Children At Home**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prev_children==1 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)


***STEP 5f: Read in data for education-stratified (4 grps) DID sens,
***create new variables, and run regression

* Dataset (RatesY_Education5Recode.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and education level counts of live births (edubirths) 
* from natality data, year by state and education level population size (edudenY) 
* from SEER data, state by year unemployment rates (Unempl), recoded expansion 
* indicator (sensexp), post expansion date indicator (post), and education level
* (newedu) 

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_Education5Recode.dta", clear

*create numerical value for state id, year and log of births
egen statenum = group(mrstate)
gen lnbirth = ln(edubirths)
gen lnpop = ln(edudenY)
egen year = group(birthyear)

**Less than HS**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==1 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)

**HS**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==2 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)

**Some College**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==3 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)

**College+**
reghdfe lnbirth i.post##i.sensexp Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if newedu==4 
outreg2 using DiD_sens5recode.xls, stats(coef ci) append excel dec(3)


***STEP 5g: export log to pdf format 
translate fert_sens5recode.smcl fert_sens5recode.pdf, replace



***STEP 6: Sensitivity Analysis, address missingness
*adjusted and FE (state, year)
*covariates = unemployment, log of population size, log of popsize and interactions


***STEP 6a: Set up log
log using fert_sensmiss, replace


***STEP 6b: Read in data for marital status-stratified (2 grps) DID sens,
***create new variables, and run regression

**All missing to Married - MARRIED**

* Dataset (RatesY_MarSens1.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and marital status counts of live births (marbirths) 
* from natality data, year by state and marital status population size (mardenY) 
* from SEER data, state by year unemployment rates (Unempl), expansion 
* indicator (expansion), post expansion date indicator (post), and recoded marital status 
* (marsens1)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_MarSens1.dta", clear

*create numerical value for state id, year, and log of birth, and pop
egen statenum = group(mrstate)
gen lnbirth = ln(marbirths)
gen lnpop = ln(mardenY)
egen year = group(birthyear)

reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marsens1==1 
outreg2 using DiD_sensmiss.xls, stats(coef ci) replace excel dec(3)

**All missing to Unmarried - UNMARRIED**

* Dataset (RatesY_MarSens2.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and marital status counts of live births (marbirths) 
* from natality data, year by state and marital status population size (mardenY) 
* from SEER data, state by year unemployment rates (Unempl), expansion 
* indicator (expansion), post expansion date indicator (post), and recoded marital status 
* (marsens2)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_MarSens2.dta", clear

*create numerical value for state id, year, and log of birth, and pop
egen statenum = group(mrstate)
gen lnbirth = ln(marbirths)
gen lnpop = ln(mardenY)
egen year = group(birthyear)

reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if marsens2==2 
outreg2 using DiD_sensmiss.xls, stats(coef ci) append excel dec(3)


***STEP 6c: Read in data for parity-stratified (2 grps) DID sens,
***create new variables, and run regression

**No Children At Home**

* Dataset (RatesY_ParSens0.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and parity counts of live births (parbirths) 
* from natality data, year by state and parity population size (pardenY) 
* from SEER data, state by year unemployment rates (Unempl), expansion 
* indicator (expansion), post expansion date indicator (post), and recoded parity 
* (prevchsens0)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_ParSens0.dta", clear

*create numerical value for state id, year, and log of birth, and pop
egen statenum = group(mrstate)
gen lnbirth = ln(parbirths)
gen lnpop = ln(pardenY)
egen year = group(birthyear)

reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prevchsens0==0 
outreg2 using DiD_sensmiss.xls, stats(coef ci) append excel dec(3)

**Children At Home**

* Dataset (RatesY_ParSens1.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and parity counts of live births (parbirths) 
* from natality data, year by state and parity population size (pardenY) 
* from SEER data, state by year unemployment rates (Unempl), expansion 
* indicator (expansion), post expansion date indicator (post), and recoded parity 
* (prevchsens1)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_ParSens1.dta", clear

*create numerical value for state id, year, and log of birth, and pop
egen statenum = group(mrstate)
gen lnbirth = ln(parbirths)
gen lnpop = ln(pardenY)
egen year = group(birthyear)

reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if prevchsens1==1 
outreg2 using DiD_sensmiss.xls, stats(coef ci) append excel dec(3)

***STEP 6d: Read in data for education-stratified (4 grps) DID sens,
***create new variables, and run regression

**Less than HS**

* Dataset (RatesY_EduSens1.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and education level counts of live births (edubirths) 
* from natality data, year by state and education level population size (edudenY) 
* from SEER data, state by year unemployment rates (Unempl), expansion 
* indicator (expansion), post expansion date indicator (post), and recoded education 
* level (edusens1)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_EduSens1.dta", clear

*create numerical value for state id, year, and log of birth, and pop
egen statenum = group(mrstate)
gen lnbirth = ln(edubirths)
gen lnpop = ln(edudenY)
egen year = group(birthyear)

reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if edusens1==1 
outreg2 using DiD_sensmiss.xls, stats(coef ci) append excel dec(3)

**HS**

* Dataset (RatesY_EduSens2.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and education level counts of live births (edubirths) 
* from natality data, year by state and education level population size (edudenY) 
* from SEER data, state by year unemployment rates (Unempl), expansion 
* indicator (expansion), post expansion date indicator (post), and recoded education 
* level (edusens2)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_EduSens2.dta", clear

*create numerical value for state id, year, and log of birth, and pop
egen statenum = group(mrstate)
gen lnbirth = ln(edubirths)
gen lnpop = ln(edudenY)
egen year = group(birthyear)

reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if edusens2==2 
outreg2 using DiD_sensmiss.xls, stats(coef ci) append excel dec(3)

**Some College**

* Dataset (RatesY_EduSens3.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and education level counts of live births (edubirths) 
* from natality data, year by state and education level population size (edudenY) 
* from SEER data, state by year unemployment rates (Unempl), expansion 
* indicator (expansion), post expansion date indicator (post), and recoded education 
* level (edusens3)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_EduSens3.dta", clear

*create numerical value for state id, year, and log of birth, and pop
egen statenum = group(mrstate)
gen lnbirth = ln(edubirths)
gen lnpop = ln(edudenY)
egen year = group(birthyear)

reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if edusens3==3 
outreg2 using DiD_sensmiss.xls, stats(coef ci) append excel dec(3)

**College+**

* Dataset (RatesY_EduSens4.dta) created using R and includes state(mrstate), 
* year(birthyear), year by state and education level counts of live births (edubirths) 
* from natality data, year by state and education level population size (edudenY) 
* from SEER data, state by year unemployment rates (Unempl), expansion 
* indicator (expansion), post expansion date indicator (post), and recoded education 
* level (edusens4)

use "D:\Groups\EBO\NCHS\Created Datasets\Project-Specific Datasets\Medicaid Expansion\Fertility\STATA\RatesY_EduSens4.dta", clear

*create numerical value for state id, year, and log of birth, and pop
egen statenum = group(mrstate)
gen lnbirth = ln(edubirths)
gen lnpop = ln(edudenY)
egen year = group(birthyear)

reghdfe lnbirth i.post##i.expansion Unempl lnpop c.lnpop#i.statenum c.lnpop#i.year, absorb(i.statenum i.year) vce(cl i.statenum), if edusens4==4 
outreg2 using DiD_sensmiss.xls, stats(coef ci) append excel dec(3)

***STEP 6e: export log to pdf format 
translate fert_sensmiss.smcl fert_sensmiss.pdf, replace
